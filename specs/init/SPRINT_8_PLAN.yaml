sprint: 8
goal: Gallery - Visual Showcase
duration: 4-5 days
note: FAQ was moved to Sprint 3, Deployment added as Sprint 4. This sprint focuses solely on Gallery functionality.

sections:
  - name: Database Setup
    tasks:
      - id: add-gallery-model
        status: pending
        description: Add Gallery model to Prisma schema
        file: libs/database/prisma/schema.prisma
        model:
          GalleryImage:
            - id: String (cuid)
            - title: String (optional, Russian)
            - description: String (optional, Russian)
            - imageUrl: String (S3/MinIO URL)
            - thumbnailUrl: String (optimized thumbnail)
            - width: Int
            - height: Int
            - order: Int (for manual sorting)
            - isPublished: Boolean
            - createdAt: DateTime
            - updatedAt: DateTime
        steps:
          - Add GalleryImage model to schema.prisma
          - Run: cd libs/database && npx prisma migrate dev --name add-gallery
          - Run: cd libs/database && npx prisma generate
      
      - id: create-gallery-seed-data
        status: pending
        description: Add sample Gallery data
        file: libs/database/prisma/seed.ts
        steps:
          - Create 2-3 sample gallery images (using placeholder URLs initially)
          - Run: cd libs/database && npm run db:seed

  - name: Backend - Gallery Module
    tasks:
      - id: install-image-packages
        status: pending
        description: Install image processing dependencies
        commands:
          - cd apps/api && npm install sharp @aws-sdk/client-s3 @aws-sdk/lib-storage multer
          - cd apps/api && npm install -D @types/multer
        notes: |
          - sharp: Image optimization and thumbnail generation
          - @aws-sdk/client-s3: S3/MinIO uploads
          - multer: File upload handling
      
      - id: create-gallery-module
        status: pending
        description: Create NestJS Gallery module structure
        files:
          - apps/api/src/app/gallery/gallery.module.ts
          - apps/api/src/app/gallery/gallery.controller.ts
          - apps/api/src/app/gallery/gallery.service.ts
          - apps/api/src/app/gallery/dto/create-gallery-image.dto.ts
          - apps/api/src/app/gallery/dto/update-gallery-image.dto.ts
          - apps/api/src/app/gallery/dto/gallery-image-response.dto.ts
      
      - id: create-upload-service
        status: pending
        description: Create image upload service
        file: apps/api/src/app/gallery/upload.service.ts
        implement:
          - uploadImage(file: Express.Multer.File) - Upload to S3/MinIO
          - generateThumbnail(buffer: Buffer) - Create optimized thumbnail with sharp
          - deleteImage(imageUrl: string) - Delete from S3/MinIO
          - extractImageDimensions(buffer: Buffer) - Get width/height with sharp
        config:
          - S3_BUCKET: process.env.S3_BUCKET
          - S3_REGION: process.env.AWS_REGION
          - AWS_ENDPOINT: process.env.AWS_ENDPOINT (for MinIO, optional)
          - Thumbnail size: 400x300 (maintain aspect ratio)
          - Image optimization: quality 80, format webp
        example: |
          import sharp from 'sharp';
          import { S3Client, PutObjectCommand } from '@aws-sdk/client-s3';
          
          // Configure S3 client (works with both AWS S3 and MinIO)
          const s3Client = new S3Client({
            region: process.env.AWS_REGION,
            endpoint: process.env.AWS_ENDPOINT, // For MinIO: http://localhost:9000
            forcePathStyle: true, // Required for MinIO
            credentials: {
              accessKeyId: process.env.AWS_ACCESS_KEY_ID,
              secretAccessKey: process.env.AWS_SECRET_ACCESS_KEY,
            },
          });
          
          async generateThumbnail(buffer: Buffer): Promise<Buffer> {
            return await sharp(buffer)
              .resize(400, 300, { fit: 'inside' })
              .webp({ quality: 80 })
              .toBuffer();
          }
      
      - id: implement-gallery-service
        status: pending
        description: Implement Gallery CRUD operations
        file: apps/api/src/app/gallery/gallery.service.ts
        methods:
          - findAll(includeUnpublished: boolean) - Get all images (ordered)
          - findOne(id: string) - Get single image
          - create(file, createDto) - Upload and create gallery image
          - update(id: string, updateDto, file?) - Update image (optional new file)
          - delete(id: string) - Delete image and files from S3
          - reorder(ids: string[]) - Update order
        steps:
          - Use UploadService for S3 operations
          - Use sharp to extract dimensions
          - Store both full image and thumbnail URLs
      
      - id: create-gallery-dtos
        status: pending
        description: Create validation DTOs for Gallery
        files:
          - apps/api/src/app/gallery/dto/create-gallery-image.dto.ts
          - apps/api/src/app/gallery/dto/update-gallery-image.dto.ts
        validation:
          - title: Optional, max 100 chars
          - description: Optional, max 500 chars
          - order: Optional number
          - isPublished: Optional boolean, defaults to true
      
      - id: create-gallery-endpoints
        status: pending
        description: Create Gallery REST endpoints with file upload
        file: apps/api/src/app/gallery/gallery.controller.ts
        endpoints:
          - GET /api/gallery - Get all published images (public)
          - GET /api/gallery/all - Get all images including unpublished (admin only)
          - GET /api/gallery/:id - Get single image (public if published)
          - POST /api/gallery - Create image with upload (admin only)
          - PATCH /api/gallery/:id - Update image (admin only)
          - DELETE /api/gallery/:id - Delete image (admin only)
          - POST /api/gallery/reorder - Reorder images (admin only)
        file_upload:
          - Use @UseInterceptors(FileInterceptor('image'))
          - Validate file type: jpeg, jpg, png, webp
          - Max file size: 10MB
          - Use multer for file handling
        example: |
          @Post()
          @UseGuards(JwtAuthGuard)
          @UseInterceptors(FileInterceptor('image'))
          async create(
            @UploadedFile() file: Express.Multer.File,
            @Body() createDto: CreateGalleryImageDto,
          ) {
            return this.galleryService.create(file, createDto);
          }
      
      - id: update-app-module-gallery
        status: pending
        description: Wire up Gallery module
        file: apps/api/src/app/app.module.ts
        steps:
          - Import GalleryModule
          - Add to imports array

  - name: v0.dev Component Generation
    tasks:
      - id: v0-gallery-grid
        status: pending
        description: Generate gallery grid with lightbox
        v0_prompt: |
          Create a beautiful image gallery component with:
          
          Layout:
          - Section title: "Галерея" (Gallery)
          - Responsive grid of images (3-4 columns on desktop, 2 on tablet, 1 on mobile)
          - Masonry or uniform grid layout
          - Image cards with optional title overlay
          
          Lightbox:
          - Click image to open fullscreen lightbox
          - Navigation arrows (prev/next)
          - Close button
          - Swipe support for mobile
          - Display image title and description in lightbox
          - Smooth transitions
          
          Requirements:
          - Use Shadcn UI Dialog for lightbox
          - Use Tailwind v4
          - Beautiful image presentation
          - Responsive images
          - Loading states for images
          - Props: images: Array<{ id: string, imageUrl: string, thumbnailUrl: string, title?: string, description?: string }>
          
          Note: Component should be React for use in Astro island.
        
        output_file: packages/public/src/components/GalleryGrid.tsx
        
        alternative_library: |
          If v0.dev implementation is complex, consider using:
          - yet-another-react-lightbox package
          - Simple to integrate
          - Great mobile support
          - npm install yet-another-react-lightbox
        
        notes: |
          v0.dev will generate the gallery grid and lightbox.
          Use as React island in Astro page.
          Ensure images are lazy-loaded for performance.

  - name: Frontend Admin - Gallery Management
    tasks:
      - id: install-gallery-packages
        status: pending
        description: Install file upload and drag-drop dependencies
        commands:
          - cd packages/admin && npm install react-dropzone
          - cd packages/admin && npm install @dnd-kit/core @dnd-kit/sortable @dnd-kit/utilities
        notes: |
          - react-dropzone: File upload with drag & drop
          - @dnd-kit: Reordering images
      
      - id: create-gallery-api-client
        status: pending
        description: Create Gallery API hooks with TanStack Query
        file: packages/admin/src/hooks/use-gallery.ts
        hooks:
          - useGalleryImages() - useQuery for all images (GET /api/gallery/all)
          - useGalleryImage(id) - useQuery for single image (GET /api/gallery/:id)
          - useCreateGalleryImage() - useMutation with FormData (POST /api/gallery)
          - useUpdateGalleryImage() - useMutation (PATCH /api/gallery/:id)
          - useDeleteGalleryImage() - useMutation (DELETE /api/gallery/:id)
          - useReorderGalleryImages() - useMutation (POST /api/gallery/reorder)
        notes: |
          File upload requires FormData:
          
          const formData = new FormData();
          formData.append('image', file);
          formData.append('title', title);
          formData.append('description', description);
          
          api.post('gallery', { body: formData })
      
      - id: create-gallery-schema
        status: pending
        description: Create Zod schema for Gallery validation
        file: packages/admin/src/schemas/gallery.schema.ts
        implement:
          - title: Optional, max 100 chars
          - description: Optional, max 500 chars
          - image: File validation (type, size)
          - order: Optional number
          - isPublished: Boolean, defaults to true
        example: |
          import { z } from 'zod'
          
          export const galleryImageSchema = z.object({
            title: z.string().max(100, 'Заголовок не должен превышать 100 символов').optional(),
            description: z.string().max(500, 'Описание не должно превышать 500 символов').optional(),
            isPublished: z.boolean().default(true),
          })
          
          // For file validation in form
          export const imageFileSchema = z.instanceof(File)
            .refine(file => file.size <= 10 * 1024 * 1024, 'Размер файла не должен превышать 10MB')
            .refine(
              file => ['image/jpeg', 'image/jpg', 'image/png', 'image/webp'].includes(file.type),
              'Допустимые форматы: JPEG, PNG, WebP'
            )
      
      - id: create-gallery-list-page
        status: pending
        description: Create Gallery list/management page
        file: packages/admin/src/pages/GalleryPage.tsx
        features:
          - Display images in grid (thumbnails)
          - Show title, published status
          - Actions: Edit, Delete, Toggle published
          - "Upload Image" button to open upload dialog
          - Drag-and-drop to reorder images
          - Preview on hover/click
          - Empty state when no images
        components_to_create:
          - GalleryGrid component (admin version)
          - ImageUploadDialog component
          - ImageEditDialog component
      
      - id: create-image-upload-form
        status: pending
        description: Create image upload form with drag-and-drop
        file: packages/admin/src/components/gallery/ImageUploadForm.tsx
        steps:
          - Use react-dropzone for file selection
          - Preview selected image before upload
          - TanStack Form for title/description
          - Zod validation
          - Upload progress indicator (optional)
          - Handle upload with FormData
        ui_features:
          - Drag-and-drop zone
          - Click to browse files
          - Image preview thumbnail
          - File size/type validation
          - Error messages in Russian
        example: |
          import { useDropzone } from 'react-dropzone'
          import { useForm } from '@tanstack/react-form'
          
          const { getRootProps, getInputProps, acceptedFiles } = useDropzone({
            accept: { 'image/*': ['.jpeg', '.jpg', '.png', '.webp'] },
            maxSize: 10 * 1024 * 1024,
            maxFiles: 1,
          })
      
      - id: add-gallery-route
        status: pending
        description: Add Gallery route to admin router
        file: packages/admin/src/router.tsx
        steps:
          - Create galleryRoute with path '/gallery'
          - Import GalleryPage component
          - Add to route tree
          - Protect with beforeLoad auth check
          - Add link to Gallery page in admin navigation

  - name: Public Site - Gallery Page
    tasks:
      - id: create-gallery-fetcher
        status: pending
        description: Create API fetcher for Gallery data in Astro
        file: packages/public/src/lib/api.ts
        implement:
          - getGalleryImages() - Fetch published images from API
          - Use native fetch with API base URL
          - Error handling
        example: |
          const API_URL = import.meta.env.PUBLIC_API_URL || 'http://localhost:3000/api';
          
          export async function getGalleryImages() {
            const response = await fetch(`${API_URL}/gallery`);
            if (!response.ok) throw new Error('Failed to fetch gallery images');
            return response.json();
          }
      
      - id: create-gallery-astro-page
        status: pending
        description: Create Gallery page in Astro
        file: packages/public/src/pages/gallery.astro
        steps:
          - Import base layout
          - Fetch images in frontmatter using getGalleryImages()
          - Render GalleryGrid React component as island
          - Add SEO meta tags (title, description in Russian)
          - Handle empty state (no images)
          - Handle loading/error states
          - Lazy load images for performance
        example: |
          ---
          import Layout from '../layouts/Layout.astro';
          import GalleryGrid from '../components/GalleryGrid';
          import { getGalleryImages } from '../lib/api';
          
          const images = await getGalleryImages();
          ---
          
          <Layout title="Галерея">
            <section class="container mx-auto py-12">
              <GalleryGrid images={images} client:load />
            </section>
          </Layout>
        notes: |
          Use client:load for lightbox interactivity.
          Consider using client:visible for lazy-loading the component.
      
      - id: add-gallery-navigation
        status: pending
        description: Add Gallery link to public site navigation
        file: packages/public/src/components/Navigation.astro
        steps:
          - Add "Галерея" (Gallery) link to main navigation
          - Link to /gallery page

  - name: Image Optimization
    tasks:
      - id: configure-astro-image
        status: pending
        description: Configure Astro image optimization
        file: packages/public/astro.config.mjs
        steps:
          - Enable image optimization in Astro config
          - Configure responsive image sizes
          - Set up formats (webp, avif fallbacks)
        example: |
          import { defineConfig } from 'astro/config';
          import image from '@astrojs/image';
          
          export default defineConfig({
            integrations: [
              image({
                serviceEntryPoint: '@astrojs/image/sharp',
              }),
            ],
          });
      
      - id: implement-responsive-images
        status: pending
        description: Use responsive images in gallery
        file: packages/public/src/components/GalleryGrid.tsx
        steps:
          - Use <Image> component from Astro or picture element
          - Generate srcset for different screen sizes
          - Use thumbnailUrl for grid, imageUrl for lightbox
          - Lazy load images with loading="lazy"
          - Add blur placeholder (optional)
        notes: |
          For React components in Astro islands, use native <img> with srcset
          or import Image from 'astro:assets' if possible.
      
      - id: optimize-backend-images
        status: pending
        description: Ensure backend generates optimized images
        file: apps/api/src/app/gallery/upload.service.ts
        verify:
          - Full images optimized: max 1920px width, quality 85, webp format
          - Thumbnails: 400x300, quality 80, webp format
          - Extract and store dimensions
          - Progressive loading support
        notes: |
          Sharp configuration:
          
          // Full image
          await sharp(buffer)
            .resize(1920, null, { fit: 'inside', withoutEnlargement: true })
            .webp({ quality: 85 })
            .toBuffer();
          
          // Thumbnail
          await sharp(buffer)
            .resize(400, 300, { fit: 'cover' })
            .webp({ quality: 80 })
            .toBuffer();

  - name: MinIO Setup (Development)
    tasks:
      - id: setup-minio-docker
        status: pending
        description: Set up MinIO for local S3-compatible storage
        steps:
          - Add MinIO service to docker-compose.yml
          - Start MinIO: docker-compose up -d minio
          - Access console: http://localhost:9001
          - Login with minioadmin/minioadmin
          - Create bucket: baker-website-images
          - Set bucket to public read access
        docker_compose: |
          services:
            minio:
              image: minio/minio
              ports:
                - "9000:9000"
                - "9001:9001"
              environment:
                MINIO_ROOT_USER: minioadmin
                MINIO_ROOT_PASSWORD: minioadmin
              command: server /data --console-address ":9001"
              volumes:
                - minio_data:/data
          
          volumes:
            minio_data:
      
      - id: update-env-variables
        status: pending
        description: Update environment variables for S3/MinIO
        file: .env
        add:
          - AWS_ACCESS_KEY_ID=minioadmin
          - AWS_SECRET_ACCESS_KEY=minioadmin
          - AWS_REGION=us-east-1
          - AWS_ENDPOINT=http://localhost:9000
          - S3_BUCKET=baker-website-images
        notes: |
          For production AWS S3:
          - Use real AWS credentials
          - Remove AWS_ENDPOINT (or leave empty)
          - forcePathStyle should be false for AWS S3

  - name: Testing & Validation
    tasks:
      - id: test-gallery-crud
        status: pending
        description: Test Gallery CRUD operations
        steps:
          - Start MinIO: docker-compose up -d minio
          - Start API: cd apps/api && npm run dev
          - Start Admin: cd packages/admin && npm run dev
          - Navigate to /gallery in admin
          - Upload new image (test drag & drop)
          - Verify image uploaded to MinIO
          - Verify thumbnail generated
          - Edit image title/description
          - Toggle published status
          - Delete image
          - Verify image deleted from MinIO
          - Reorder images
      
      - id: test-file-upload
        status: pending
        description: Test file upload edge cases
        verify:
          - Large file (>10MB) rejected with error
          - Invalid file type rejected (PDF, TXT, etc.)
          - Image preview shows correctly
          - Upload progress indication (if implemented)
          - Multiple uploads work correctly
          - MinIO/S3 upload failures handled gracefully
      
      - id: test-public-gallery-page
        status: pending
        description: Test public Gallery page
        steps:
          - Start public site: cd packages/public && npm run dev
          - Navigate to /gallery
          - Verify images display in grid
          - Test lightbox open/close
          - Test navigation between images in lightbox
          - Verify thumbnails load fast
          - Test responsive grid layout
          - Verify only published images show
          - Test lazy loading
      
      - id: test-image-optimization
        status: pending
        description: Verify image optimization works
        verify:
          - Images converted to WebP format
          - Thumbnails are smaller file size
          - Full images respect max dimensions
          - Images load progressively
          - Lazy loading works on gallery page
          - Responsive images serve correct sizes

validation:
  - API /api/gallery endpoints work correctly
  - Admin can upload/edit/delete gallery images
  - Images upload to MinIO successfully
  - Thumbnails generate correctly
  - Public Gallery page displays published images
  - Gallery lightbox works correctly
  - Image optimization reduces file sizes
  - Responsive images work on mobile
  - Only published items show on public site
  - Navigation links work on public site

v0_workflow:
  - title: Generate Gallery Grid with v0.dev
    steps:
      - Go to https://v0.dev
      - Use the v0_prompt from task v0-gallery-grid
      - Generate the component
      - Copy the component code
      - Paste into packages/public/src/components/GalleryGrid.tsx
      - Update to accept props: images array
      - Implement lightbox functionality (or use library)
      - Test in Astro page with sample data
      - Ensure it works as React island (client:load)
      - Verify image lazy loading
  
  - title: v0.dev Tips for Gallery Component
    tips:
      - Focus on clean, simple layouts
      - Ensure component works as React island in Astro
      - Request smooth animations for lightbox
      - Ask for responsive designs
      - Specify Russian text in examples
      - Can iterate if first result needs improvement
      - Consider using existing lightbox library instead of custom implementation

implementation_order:
  1. MinIO Setup:
     - Set up MinIO with Docker (15 min)
     - Create bucket and configure (15 min)
  
  2. Database:
     - Add Gallery model (30 min)
     - Create migrations and seed data (30 min)
  
  3. Backend - Gallery Module:
     - Install image packages (15 min)
     - Create upload service with sharp + S3 (3 hours)
     - Create gallery module and service (2 hours)
     - Create endpoints with file upload (1 hour)
     - Test file upload (1 hour)
  
  4. Admin - Gallery Management:
     - Install upload packages (15 min)
     - Create TanStack Query hooks (1 hour)
     - Create Zod schema (30 min)
     - Generate gallery grid (1 hour)
     - Create upload form with dropzone (2 hours)
     - Implement reordering (1 hour)
     - Add routes and navigation (30 min)
     - Test uploads and CRUD (1 hour)
  
  5. Public Site - v0.dev Component:
     - Generate gallery grid with v0.dev (30 min)
     - Integrate in Astro as React island (30 min)
  
  6. Public Site - Gallery Page:
     - Create API fetcher (30 min)
     - Create Gallery page (1 hour)
     - Add navigation link (15 min)
     - Test public page (30 min)
  
  7. Image Optimization:
     - Configure Astro image optimization (30 min)
     - Implement responsive images (1 hour)
     - Verify optimization works (30 min)
  
  8. Testing & Polish:
     - End-to-end testing (2 hours)
     - Fix issues (1-2 hours buffer)

notes:
  - MinIO provides S3-compatible local storage for development
  - Can use MinIO for local dev, AWS S3 for production (same code)
  - MinIO web console makes bucket management easy
  - Image optimization is critical for performance
  - Lazy loading essential for gallery page
  - Use thumbnails in grids, full images in lightbox
  - React islands in Astro provide interactivity
  - Gallery is image-heavy, ensure good performance
  - Russian language for all public-facing text
  - Admin can be Russian or English (your choice)
  - Ensure only published items show on public site
  - Consider CDN for S3 images in production
  - WebP format for modern browsers, JPEG fallback if needed
  - TanStack Query caching improves admin performance
  - File upload requires multipart/form-data
  - Sharp is faster than alternatives for image processing
  - Test with various image sizes and formats
  - Implement error handling for S3/MinIO failures
  - Consider image upload progress indicators
  - forcePathStyle: true required for MinIO

s3_minio_configuration:
  development_minio:
    - "Local S3-compatible storage for development"
    - "Lighter and faster than LocalStack for S3-only use"
    - "Compatible with AWS S3 SDK - same code works for both"
    - "Console: http://localhost:9001 (user: minioadmin, pass: minioadmin)"
    - "API endpoint: http://localhost:9000"
    - "Create bucket 'baker-website-images' via console"
    - "Set bucket access policy to public for read"
    - env_config: |
        AWS_ACCESS_KEY_ID=minioadmin
        AWS_SECRET_ACCESS_KEY=minioadmin
        AWS_REGION=us-east-1
        AWS_ENDPOINT=http://localhost:9000
        S3_BUCKET=baker-website-images
    - important_notes: |
        1. Must set forcePathStyle: true in S3Client config for MinIO
        2. Remove AWS_ENDPOINT for production AWS S3 (or leave it empty)
        3. MinIO console at http://localhost:9001 for bucket management
        4. Create bucket and set to public before uploading
        5. Same upload code works for both MinIO (dev) and AWS S3 (prod)
  
  production_aws_s3:
    - Create S3 bucket in AWS console
    - Enable public read access for images
    - Configure CORS on bucket to allow uploads from API
    - Create IAM user with S3 permissions
    - Get access key and secret key
    - Add credentials to .env file
    - Leave AWS_ENDPOINT empty or unset
    - Set forcePathStyle: false (or omit it)
  
  bucket_policy_example: |
    {
      "Version": "2012-10-17",
      "Statement": [
        {
          "Sid": "PublicReadGetObject",
          "Effect": "Allow",
          "Principal": "*",
          "Action": "s3:GetObject",
          "Resource": "arn:aws:s3:::baker-website-images/*"
        }
      ]
    }
  
  cors_configuration: |
    [
      {
        "AllowedHeaders": ["*"],
        "AllowedMethods": ["GET", "PUT", "POST", "DELETE"],
        "AllowedOrigins": ["*"],
        "ExposeHeaders": ["ETag"]
      }
    ]
  
  folder_structure:
    - gallery/full/ - Full optimized images
    - gallery/thumbnails/ - Thumbnail images

completion_checklist:
  - [ ] MinIO running and accessible
  - [ ] Database has GalleryImage model
  - [ ] Gallery CRUD endpoints work
  - [ ] S3/MinIO image upload works
  - [ ] Thumbnail generation works
  - [ ] Admin Gallery management page functional
  - [ ] File upload with drag & drop works
  - [ ] Image reordering works
  - [ ] Public Gallery page displays correctly
  - [ ] Gallery lightbox works
  - [ ] Image optimization reduces file sizes
  - [ ] Responsive images load correctly
  - [ ] Only published items show on public site
  - [ ] Navigation link added to public site
  - [ ] Error handling works for uploads
  - [ ] File size/type validation works
  - [ ] Images lazy load on gallery page
  - [ ] SEO meta tags present on public page

time_estimate:
  - MinIO setup: 30 min
  - Database setup: 1 hour
  - Backend Gallery module with S3/MinIO: 7 hours
  - Admin Gallery management: 6 hours
  - v0.dev component: 1 hour
  - Public site Gallery page: 2 hours
  - Image optimization: 2 hours
  - Testing and fixes: 2-3 hours
  - Total: 21-22 hours (3 days with focus, 4-5 days comfortable pace)

